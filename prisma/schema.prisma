// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String
  password    String
  phone       String?
  address     String?
  avatar      String?
  latitude    Float?
  longitude   Float?
  city        String?
  isAdmin     Boolean  @default(false)
  reputation  Float    @default(0) // Điểm uy tín
  totalReviews Int     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items         Item[]
  exchanges     Exchange[] @relation("UserExchanges")
  favorites     Favorite[]
  reviewsGiven  Review[]   @relation("Reviewer")
  reviewsReceived Review[] @relation("Reviewee")
  sentMessages  Message[]  @relation("Sender")
  receivedMessages Message[] @relation("Receiver")
  transactions  Transaction[] @relation("Buyer")
  notifications Notification[]
}

model Item {
  id            String   @id @default(cuid())
  title         String
  description   String
  category      String
  condition     String   // Mới, Còn tốt, Đã qua sử dụng
  images        String?  // JSON array of image URLs
  status        String   @default("available") // available, exchanged, removed, pending
  transactionType String @default("exchange") // exchange, gift, sell
  price         Float?   // Giá nếu là bán
  latitude      Float?
  longitude     Float?
  city          String?
  address       String?
  views         Int      @default(0)
  qrCode        String?  @unique
  promoVideoUrl String?  // URL video giới thiệu AI tạo
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  exchanges     Exchange[]
  favorites     Favorite[]
  transactions  Transaction[]
}

model Exchange {
  id          String   @id @default(cuid())
  itemId      String
  item        Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation("UserExchanges", fields: [userId], references: [id], onDelete: Cascade)
  status      String   @default("pending") // pending, accepted, rejected, completed
  message     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  itemId    String
  item      Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, itemId])
}

model Review {
  id          String   @id @default(cuid())
  rating      Int      // 1-5 sao
  comment     String?
  reviewerId  String
  reviewer    User     @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  revieweeId  String
  reviewee    User     @relation("Reviewee", fields: [revieweeId], references: [id], onDelete: Cascade)
  transactionId String? // Liên kết với giao dịch
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Message {
  id          String   @id @default(cuid())
  senderId    String
  sender      User     @relation("Sender", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId  String
  receiver    User     @relation("Receiver", fields: [receiverId], references: [id], onDelete: Cascade)
  itemId      String?  // Liên kết với món đồ nếu có
  content     String
  image       String?
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model Transaction {
  id            String   @id @default(cuid())
  itemId        String
  item          Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  buyerId       String
  buyer         User     @relation("Buyer", fields: [buyerId], references: [id], onDelete: Cascade)
  sellerId      String   // userId của người bán
  transactionType String // exchange, gift, sell
  status        String   @default("pending") // pending, confirmed, completed, cancelled
  qrCode        String?  @unique
  confirmedAt   DateTime?
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String   // exchange_request, chat, favorite, transaction
  title       String
  message     String
  link        String?  // Link đến trang liên quan
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
}

